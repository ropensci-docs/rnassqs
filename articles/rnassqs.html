<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rnassqs">
<title>Using rnassqs • rnassqs</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using rnassqs">
<meta property="og:description" content="rnassqs">
<meta property="og:image" content="https://docs.ropensci.org/rnassqs/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">rnassqs</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.6.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="active nav-item">
  <a class="nav-link" href="../articles/rnassqs.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/rnassqs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using rnassqs</h1>
                        <h4 data-toc-skip class="author">Nicholas A Potter</h4>
            
            <h4 data-toc-skip class="date">2024-02-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rnassqs/blob/HEAD/vignettes/rnassqs.Rmd" class="external-link"><code>vignettes/rnassqs.Rmd</code></a></small>
      <div class="d-none name"><code>rnassqs.Rmd</code></div>
    </div>

    
    
<p><code>rnassqs</code> is a package to access the QuickStats API from national agricultural statistics service (NASS) at the USDA. There are at least two good reasons to do this:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Reproducibility</strong>. downloading the data via an R script creates a trail that you can revisit later to see exactly what you downloaded. It also makes it much easier for people seeking to replicate your results to ensure they have the same data that you do.</p></li>
<li><p><strong>DRY</strong>. Don’t repeat yourself. Downloading data via API makes it easier to download new data as it is released, and to fetch multiple variables, geographies, or time frames without having to manually click through the QuickStats tool for each data request.</p></li>
</ol>
<p>In the beginning it can be more confusing, and potentially take more time, but as you become familiar with the variables and calls of the <code>rnassqs</code> package and the QuickStats database, you’ll be able to quickly and easily download new data.</p>
<div class="section level2">
<h2 id="api-information">API Information<a class="anchor" aria-label="anchor" href="#api-information"></a>
</h2>
<p>The USDA-NASS Quick Stats API has a graphic interface here: <a href="https://quickstats.nass.usda.gov" class="external-link">https://quickstats.nass.usda.gov</a>. Information on the query parameters is found at <a href="https://quickstats.nass.usda.gov/api/#param_define" class="external-link">https://quickstats.nass.usda.gov/api/#param_define</a>.</p>
</div>
<div class="section level2">
<h2 id="a-quick-example">A quick example<a class="anchor" aria-label="anchor" href="#a-quick-example"></a>
</h2>
<p>First, obtain an API key from the ‘Quick Stats’ service: <a href="https://quickstats.nass.usda.gov/api/" class="external-link">https://quickstats.nass.usda.gov/api/</a>. Then we can make a query. Here we request the number of farm operators by operation acreage in Oregon in 2012.</p>
<pre><code>library(rnassqs)

# Specify the query parameters
params &lt;- list(
  commodity_desc = "OPERATORS",
  domain_desc = "AREA OPERATED"
  agg_level_desc = "STATE",
  state_alpha = "OR",
  year = 2012
)

# Check that our record request is under the 50,000 limit
nassqs_record_count(params)

# Get the data
d &lt;- nassqs(params)</code></pre>
<p>Parameters need not be specified in a list and need not be capitalized. The following is equivalent</p>
<pre><code><span><span class="co"># Get the data specifying each parameter as a separate argument to the </span></span>
<span><span class="co"># function `rnassqs`</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs.html">nassqs</a></span><span class="op">(</span>commodity_desc <span class="op">=</span> <span class="st">"operators"</span>, </span>
<span>            domain_desc <span class="op">=</span> <span class="st">"area operated"</span>,</span>
<span>            agg_level_desc <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>            state_alpha <span class="op">=</span> <span class="st">"or"</span>,</span>
<span>            year <span class="op">=</span> <span class="fl">2012</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="convenience-functions">Convenience functions<a class="anchor" aria-label="anchor" href="#convenience-functions"></a>
</h2>
<p>A growing list of convenience functions makes querying simpler. For example, you can retrieve yields and acres with</p>
<pre><code># Set parameters
params &lt;- list(
  commodity_desc = "APPLES",
  domaincat_desc = "NOT SPECIFIED"
  agg_level_desc = "STATE",
  state_alpha = "OR",
  year = 2012
)

# Yields and Acres
yields &lt;- nassqs_yields(params)
acres &lt;- nassqs_acres(params)</code></pre>
<p>You can also query by a list of fips codes:</p>
<pre><code><span><span class="fu"><a href="../reference/nassqs_byfips.html">nassqs_byfips</a></span><span class="op">(</span></span>
<span>  fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"19001"</span>, <span class="st">"17005"</span>, <span class="st">"17001"</span><span class="op">)</span>,</span>
<span>  commodity_desc <span class="op">=</span> <span class="st">"CORN"</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2019</span>,</span>
<span>  statisticcat_desc <span class="op">=</span> <span class="st">"YIELD"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="detailed-usage">Detailed usage<a class="anchor" aria-label="anchor" href="#detailed-usage"></a>
</h2>
<div class="section level3">
<h3 id="step-1-authentication">Step 1: Authentication<a class="anchor" aria-label="anchor" href="#step-1-authentication"></a>
</h3>
<p>the QuickStats API requires authentication. You can get an API Key <a href="https://quickstats.nass.usda.gov/api/" class="external-link">here</a>. Once you have a key, you can use it in any of the following ways:</p>
<div class="section level4">
<h4 id="add-it-to-your--renviron-file">Add it to your .Renviron file<a class="anchor" aria-label="anchor" href="#add-it-to-your--renviron-file"></a>
</h4>
<p>In your home directory create or edit the <code>.Renviron</code> file, and add <code>NASSQS_TOKEN = &lt;your api key&gt;</code> to the file. <code>R</code> sessions will have the variable set automatically, and <code>rnassqs</code> will detect this when querying data. If you use Rstudio, you can also use <code>usethis::edit_r_environ</code> to open your <code>.Renviron</code> file and add the key. This will create a new system environmental variable when you start a new <code>R</code> session. You can also set the environmental variable directly with <code>Sys.setenv(NASSQS_TOKEN = &lt;your api key&gt;</code>.</p>
</div>
<div class="section level4">
<h4 id="put-it-in-a-file">Put it in a file<a class="anchor" aria-label="anchor" href="#put-it-in-a-file"></a>
</h4>
<p>You can add a file to your project directory and ignore it via <code>.gitignore</code> if you’re using github. The advantage of this method is that you don’t have to think about the API key for the rest of the project, but you have to repeat this process for every new project, and you risk forgetting to add it to <code>.gitignore</code>. Once the api key is in a file, you can use it like this:</p>
<pre><code><span><span class="co"># Load the api key</span></span>
<span><span class="va">api_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"&lt;file name with api key&gt;"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/nassqs_auth.html">nassqs_auth</a></span><span class="op">(</span>key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="add-it-interactively">Add it interactively<a class="anchor" aria-label="anchor" href="#add-it-interactively"></a>
</h4>
<p>If you don’t want to add the API key to a file or store it in your <code>.Renviron</code>, you can enter it in the console in a session. This is less easy because you have to enter (or copy-paste) the key each time you begin an <code>R</code> session. In addition, you won’t be able to automate running your script, since it will stop and ask you to provide an api key.</p>
<pre><code><span><span class="co"># Checks if the api key is set and prints it. </span></span>
<span><span class="co"># If it is not set, asks the user to set the value in the console.</span></span>
<span><span class="fu"><a href="../reference/nassqs_auth.html">nassqs_auth</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="step-2-building-queries">Step 2: Building Queries<a class="anchor" aria-label="anchor" href="#step-2-building-queries"></a>
</h3>
<p>The QuickStats API offers a bewildering array of fields on which to query. <code>rnassqs</code> tries to help navigate query building with some functions that return parameter names and valid values for those parameters. <code><a href="../reference/nassqs_params.html">nassqs_params()</a></code> provides the parameter names, which at the time of this writing are</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnassqs/">rnassqs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># returns a list of fields that you can query</span></span>
<span><span class="fu"><a href="../reference/nassqs_params.html">nassqs_params</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "agg_level_desc"        "asd_code"              "asd_desc"             </span></span>
<span><span class="co">#&gt;  [4] "begin_code"            "class_desc"            "commodity_desc"       </span></span>
<span><span class="co">#&gt;  [7] "congr_district_code"   "country_code"          "country_name"         </span></span>
<span><span class="co">#&gt; [10] "county_ansi"           "county_code"           "county_name"          </span></span>
<span><span class="co">#&gt; [13] "domaincat_desc"        "domain_desc"           "end_code"             </span></span>
<span><span class="co">#&gt; [16] "freq_desc"             "group_desc"            "load_time"            </span></span>
<span><span class="co">#&gt; [19] "location_desc"         "prodn_practice_desc"   "reference_period_desc"</span></span>
<span><span class="co">#&gt; [22] "region_desc"           "sector_desc"           "short_desc"           </span></span>
<span><span class="co">#&gt; [25] "state_alpha"           "state_ansi"            "state_name"           </span></span>
<span><span class="co">#&gt; [28] "state_fips_code"       "statisticcat_desc"     "source_desc"          </span></span>
<span><span class="co">#&gt; [31] "unit_desc"             "util_practice_desc"    "watershed_code"       </span></span>
<span><span class="co">#&gt; [34] "watershed_desc"        "week_ending"           "year"                 </span></span>
<span><span class="co">#&gt; [37] "zip_5"</span></span></code></pre></div>
<p>Including parameter names in <code>nassqs_params</code> will return a description of the parameter(s) in question:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/nassqs_params.html">nassqs_params</a></span><span class="op">(</span><span class="st">"agg_level_desc"</span>, <span class="st">"source_desc"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "agg_level_desc: Geographical level of data. Often 'county', 'state', or 'national', but can include other levels as well"</span></span>
<span><span class="co">#&gt; [2] "source_desc: Data source. Either 'CENSUS' or 'SURVEY'"</span></span></code></pre></div>
<p>Documentation on all of the parameters is available at <a href="https://quickstats.nass.usda.gov/api/#param_define" class="external-link">https://quickstats.nass.usda.gov/api/#param_define</a>.</p>
<p>A list of the valid values for a given field is available via <code>nassqs_param_values(param = &lt;parameter name&gt;)</code>. For example,</p>
<pre><code><span><span class="fu"><a href="../reference/nassqs_param_values.html">nassqs_param_values</a></span><span class="op">(</span>param <span class="op">=</span> <span class="st">'source_desc'</span><span class="op">)</span></span></code></pre>
<p>returns a list of valid values for the <code>source_desc</code> parameter.</p>
<p>Building a query often involves some trial and error. One way of developing the query is to use the <a href="https://quickstats.nass.usda.gov/" class="external-link">QuickStats web interface</a>. This is often the fastest method and provides quick feedback on the subset of values for a given query. Alternatively, you can query values for each field as above and iteratively build your query. The query in the end takes the form of a list of parameters that looks like</p>
<pre><code><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>commodity_desc <span class="op">=</span> <span class="st">"CORN"</span>, year__GE <span class="op">=</span> <span class="fl">2012</span>, state_alpha <span class="op">=</span> <span class="st">"VA"</span><span class="op">)</span></span></code></pre>
<div class="section level4">
<h4 id="querying-a-range-of-values">Querying a range of values<a class="anchor" aria-label="anchor" href="#querying-a-range-of-values"></a>
</h4>
<p>Most queries will probably be for specific values such as <code>year = 2012</code>, but you may also want to query ranges of values. For those queries, append one of the following to the field you’d like to modify:</p>
<ul>
<li>__LE: less than or equal</li>
<li>__LT: less than</li>
<li>__GE: greater than or equal</li>
<li>__GT: greater than</li>
<li>__LIKE: like</li>
<li>__NOT_LIKE: not like</li>
<li>__NE: not equal</li>
</ul>
<p>In the above parameter list, <code>year__GE</code> is the <code>year</code> field with the <code>__GE</code> modifier attached to it. The returned data includes all records with year greater than or equal to 2012.</p>
</div>
<div class="section level4">
<h4 id="querying-multiple-values">Querying multiple values<a class="anchor" aria-label="anchor" href="#querying-multiple-values"></a>
</h4>
<p>Multiple values can be queried at once by including them in a simple list with <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. For example, if you’d like data from both Washington and Oregon, you can write <code>state_alpha = c('WA', 'OR')</code>.</p>
</div>
<div class="section level4">
<h4 id="query-limits">Query limits<a class="anchor" aria-label="anchor" href="#query-limits"></a>
</h4>
<p>The API only returns queries that return 50,000 or less records, so it’s a good idea to check that before running a query. Do do so, you can use <code><a href="../reference/nassqs_record_count.html">nassqs_record_count()</a></code>. Combined with an assert from the <code>assertthat</code> package, you can ensure that your queries are valid before attempting to access the data:</p>
<pre><code><span><span class="co"># Check that the number of returned records will be less than 50000</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>commodity_desc <span class="op">=</span> <span class="st">"CORN"</span>, year__GE <span class="op">=</span> <span class="fl">2012</span>, state_alpha <span class="op">=</span> <span class="st">"VA"</span><span class="op">)</span></span>
<span><span class="va">records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_record_count.html">nassqs_record_count</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="fu">assertthat</span><span class="fu">::</span><span class="fu">assert_that</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">records</span><span class="op">$</span><span class="va">count</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">50000</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="step-3-running-queries">Step 3: Running Queries<a class="anchor" aria-label="anchor" href="#step-3-running-queries"></a>
</h3>
<p>Once you’ve built a query, running it is easy:</p>
<pre><code><span><span class="co"># Run a query given a set of parameters and an API key</span></span>
<span><span class="fu"><a href="../reference/nassqs.html">nassqs</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span>, key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-4--putting-it-all-together">Step 4. Putting it all together<a class="anchor" aria-label="anchor" href="#step-4--putting-it-all-together"></a>
</h3>
<p>Putting all of the above together, we have a script that looks like:</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnassqs/">rnassqs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">assertthat</span><span class="op">)</span> <span class="co">#for checking the size of the query</span></span>
<span></span>
<span><span class="co"># Check for the API key. This prints the key if it is set, or asks for it</span></span>
<span><span class="co"># if the session is interactive</span></span>
<span><span class="fu"><a href="../reference/nassqs_auth.html">nassqs_auth</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get a list of available fields</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu">nassq_params</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get valid values for 'commodity_desc'</span></span>
<span><span class="fu"><a href="../reference/nassqs_param_values.html">nassqs_param_values</a></span><span class="op">(</span>param <span class="op">=</span> <span class="st">'source_desc'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set a list of parameters to query on</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>commodity_desc <span class="op">=</span> <span class="st">"CORN"</span>, year__GE <span class="op">=</span> <span class="fl">2012</span>, state_alpha <span class="op">=</span> <span class="st">"VA"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that the number of returned records will be less than 50000</span></span>
<span><span class="va">records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_record_count.html">nassqs_record_count</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="fu">assert_that</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">records</span><span class="op">$</span><span class="va">count</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">50000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run a query given a set of parameters and an API key</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs.html">nassqs</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span>, key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the same query but parse into a data.frame separately</span></span>
<span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_GET.html">nassqs_GET</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span>, key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span>
<span><span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_parse.html">nassqs_parse</a></span><span class="op">(</span><span class="va">raw</span>, as <span class="op">=</span> <span class="st">'data.frame'</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="lists-of-parameters-and-dealing-with-large-queries">Lists of parameters and dealing with large queries<a class="anchor" aria-label="anchor" href="#lists-of-parameters-and-dealing-with-large-queries"></a>
</h2>
<p>The ability of <code>rnassqs</code> to iterate over lists of parameters is especially helpful. In some cases you may wish to collect many different sets of data, and in others your queries may be larger than the API restriction of 50,000 records. In both cases iterating over a list of parameters is helpful.</p>
<div class="section level3">
<h3 id="iterating-to-reduce-individual-query-size">Iterating to reduce individual query size<a class="anchor" aria-label="anchor" href="#iterating-to-reduce-individual-query-size"></a>
</h3>
<p>Generally the best way to deal with large queries is to make multiple queries subset by year if possible, and by geography if not. Some care is needed if subsetting by geography. Due to suppression of data, the <em>sum of all counties in a state will not necessarily equal the state value</em>. Moreover, some data is collected only at specific geographies. It is best to start by iterating over years, so that if you want say all county cash rents on irrigated land for every year since they became available in 2008, you can iterate by doing the following:</p>
<pre><code><span><span class="co"># Define the list of parameters to use repeatedly</span></span>
<span><span class="va">param_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sector_desc <span class="op">=</span> <span class="st">"ECONOMICS"</span>,</span>
<span>  commodity_desc <span class="op">=</span> <span class="st">"RENT"</span>,</span>
<span>  prodn_practice_desc <span class="op">=</span> <span class="st">"IRRIGATED"</span>,</span>
<span>  class_desc <span class="op">=</span> <span class="st">"CASH, CROPLAND"</span>,</span>
<span>  agg_level_desc <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>  domaincat_desc <span class="op">=</span> <span class="st">"NOT SPECIFIED"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate through each year to get data  </span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">2008</span><span class="op">:</span><span class="fl">2017</span>, <span class="kw">function</span><span class="op">(</span><span class="va">yr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="va">param_list</span></span>
<span>  <span class="va">params</span><span class="op">[[</span><span class="st">'year'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">yr</span></span>
<span>  <span class="fu"><a href="../reference/nassqs.html">nassqs</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using dplyr to bind the data list</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">rbind_list</span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using data.table to bind the data list</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span></span></code></pre>
<p>Subsetting by geography works similarly, looping over the geography variable (usually <code>state_alpha</code> or <code>county_code</code> or the like) in lapply.</p>
</div>
<div class="section level3">
<h3 id="iterating-over-lists-of-parameters">Iterating over lists of parameters<a class="anchor" aria-label="anchor" href="#iterating-over-lists-of-parameters"></a>
</h3>
<p>Similar to above, at times it is helpful to make multiple queries and bind the data into a single <code>data.frame</code>. For example, you may want to collect the many different categories of acres for every Agricultural Census since 1997, which you can do with something like</p>
<pre><code><span><span class="co"># First define a base parameter list to modify for each new query</span></span>
<span><span class="va">base_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  source_desc <span class="op">=</span> <span class="st">"CENSUS"</span>,</span>
<span>  sector_desc <span class="op">=</span> <span class="st">"ECONOMICS"</span>,</span>
<span>  commodity_desc <span class="op">=</span> <span class="st">"AG LAND"</span>,</span>
<span>  agg_level_desc <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>  unit_desc <span class="op">=</span> <span class="st">"ACRES"</span>,</span>
<span>  statisticcat_desc <span class="op">=</span> <span class="st">"AREA"</span>,</span>
<span>  domain_desc <span class="op">=</span> <span class="st">"TOTAL"</span>,</span>
<span>  domaincat_desc <span class="op">=</span> <span class="st">"NOT SPECIFIED"</span>,</span>
<span>  year_GE <span class="op">=</span> <span class="fl">1997</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List of parameters that vary for each query</span></span>
<span><span class="va">param_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ag_land_other <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"(EXCL CROPLAND &amp; PASTURELAND &amp; WOODLAND)"</span><span class="op">)</span>, </span>
<span>  ag_land_irr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    prodn_practice_desc <span class="op">=</span> <span class="st">"IRRIGATED"</span>,</span>
<span>    class_desc <span class="op">=</span> <span class="st">"ALL CLASSES"</span><span class="op">)</span>,</span>
<span>  ag_woodland <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"WOODLAND"</span><span class="op">)</span>,</span>
<span>  ag_pastureland <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"PASTURELAND, (EXCL CROPLAND &amp; WOODLAND)"</span><span class="op">)</span>,</span>
<span>  ag_cropland <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"CROPLAND"</span><span class="op">)</span>,</span>
<span>  ag_cropland_excl_harvested <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"CROPLAND, (EXCL HARVESTED &amp; PASTURED)"</span><span class="op">)</span>,</span>
<span>  ag_cropland_harvested <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"CROPLAND, HARVESTED"</span>,</span>
<span>    prodn_practice_desc <span class="op">=</span> <span class="st">"ALL PRODUCTION PRACTICES"</span><span class="op">)</span>,</span>
<span>  ag_cropland_harvested_irr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    class_desc <span class="op">=</span> <span class="st">"CROPLAND, HARVESTED"</span>,</span>
<span>    prodn_practice_desc <span class="op">=</span> <span class="st">"IRRIGATED"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Iterate through different variable queries</span></span>
<span>  <span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">param_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var_params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Create the new parameter list and append the query items that vary</span></span>
<span>    <span class="co"># by query</span></span>
<span>    <span class="va">params</span> <span class="op">&lt;-</span> <span class="va">base_params</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">var_params</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">params</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">var_params</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="../reference/nassqs.html">nassqs</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Then rbind_list() or rbindlist() as above</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="under-the-hood">Under the hood<a class="anchor" aria-label="anchor" href="#under-the-hood"></a>
</h2>
<p><code>nassqs</code> is a wrapper around the <code>nassqs_GET</code> function, which uses <code><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">httr::GET</a></code> to make an HTTP GET request to the Quick Stats API. If you need to access the underlying request object generated by the GET call, you can use <code>nassqs_GET</code> to return the request object. The <code>rnassqs</code> package also has a <code>nassqs_parse</code> function that will process a request object into a data.frame, list, or raw text. <code>nassqs</code> does handles both together, but you can replicate that functionality with low-level functions as follows:</p>
<pre><code><span><span class="co"># Make a HTTP GET request and parse into a data.frame with separate</span></span>
<span><span class="co"># function calls. The below is equivalent to </span></span>
<span><span class="co"># 'nassqs(params, key = api_key)'</span></span>
<span><span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_GET.html">nassqs_GET</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span>, key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span>
<span><span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nassqs_parse.html">nassqs_parse</a></span><span class="op">(</span><span class="va">request</span>, as <span class="op">=</span> <span class="st">'data.frame'</span><span class="op">)</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
